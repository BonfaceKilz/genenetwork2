{%extends "base.html"%}
{%from "oauth2/profile_nav.html" import profile_nav%}
{%from "oauth2/display_error.html" import display_error%}

{%block title%}Link Data: Genotype{%endblock%}

{%block css%}
<link rel="stylesheet" type="text/css"
      href="/css/DataTables/css/jquery.dataTables.css" />
<link rel="stylesheet" type="text/css"
      href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
<link rel="stylesheet" type="text/css" href="/static/new/css/show_trait.css" />
{%endblock%}

{%block content%}
<div class="container" style="width: 98%;">
  {{profile_nav("data", user_privileges)}}

  {{flash_me()}}

  <div class="row">
    <noscript>This page needs javascript to work correctly</noscript>
  </div>

  <div class="row">
    <form id="frm-link-genotypes">
      <legend>Link Genotype Traits to Group</legend>

      <div class="form-group">
	<label for="select-group">Group</label>
	<select id="select-group" name="group_id" required="required"
		class="form-control">
	  <option value="">Select group</option>
	  {%for group in groups%}
	  <option value="{{group.group_id}}">{{group.group_name}}</option>
	  {%endfor%}
	</select>
      </div>

      <div class="form-group">
      <table id="tbl-link-genotypes"
	     class="table-hover table-striped cell-border dataTable no-footer"
	     data-selected-datasets='{{selected_datasets | list | tojson}}'>
	<thead>
	  <tr>
	    <th>Deselect</th>
	    <th>Group</th>
	    <th>Dataset Name</th>
	    <th>Dataset FullName</th>
	    <th>Dataset ShortName</th>
	  </tr>
	</thead>
	<tbody>
	  {%for dataset in selected_datasets%}
	  <tr>
	    <td>
	      <input type="checkbox" class="checkbox checkbox-link"
		     name="selected_datasets"
		     value='{{dataset | tojson}}' />
	    </td>
	    <td>{{dataset.dataset_name}}</td>
	    <td>{{dataset.dataset_fullname}}</td>
	    <td>{{dataset.dataset_shortname}}</td>
	  </tr>
	  {%else%}
	  <tr>
	    <td colspan="100%" align="center">
	      <span class="glyphicon glyphicon-info-sign text-info"></span>
	      &nbsp
	      No datasets selected for linking.
	    </td>
	  </tr>
	  {%endfor%}
	</tbody>
      </table>
      </div>

      <div class="form-group text-center">
	<input type="submit" value="Link Selected"
	       class="btn btn-primary"
	       style="border-top: 0.3em;"
	       {%if groups | length <= 0 or selected_datasets | length <= 0%}
	       disabled="disabled"
	       {%endif%} />
      </div>
    </form>
  </div>

  <div class="row">
    <span id="search-messages" class="alert-danger" style="display:none"></span>
    <form id="frm-search-traits"
	  action="#"
	  method="POST">
      <legend>Search: Genotype</legend>
      <input type="hidden" value="{{species_name}}" name="species"
	     id="txt-species" />
      <input type="hidden" value="{{dataset_type}}" name="dataset_type"
	     id="txt-dataset-type"  />
      <input type="hidden" value="{{per_page}}" name="per_page"
	     id="txt-per-page"  />

      <div class="form-group">
	<label for="txt-query">Dataset Search String</label>
	<input type="text" id="txt-query" name="query" class="form-control"
	       value="{{query}}"/>
      </div>
    </form>
  </div>

  <div class="row">
    <table id="tbl-genotypes"
	   class="table-hover table-striped cell-border dataTable no-footer"
	   data-datasets='{{datasets | list | tojson}}'>
      <thead>
	<tr>
	  <th>Select</th>
	  <th>Group</th>
	  <th>Dataset Name</th>
	  <th>Dataset FullName</th>
	  <th>Dataset ShortName</th>
	</tr>
      </thead>
      <tbody>
	{%for dataset in datasets:%}
	<tr>
	  <td>
	    <input type="checkbox" class="checkbox checkbox-search"
		   name="search_datasets"
		   value='{{dataset | tojson}}' />
	  </td>
	  <td>{{dataset.InbredSetName}}</td>
	  <td>{{dataset.dataset_name}}</td>
	  <td>{{dataset.dataset_fullname}}</td>
	  <td>{{dataset.dataset_shortname}}</td>
	</tr>
        {%else%}
	<tr>
	  <td colspan="100%" align="center">
	      <span class="glyphicon glyphicon-info-sign text-info"></span>
	      &nbsp
	      No datasets available for selection.
	  </td>
	</tr>
	{%endfor%}
      </tbody>
    </table>
  </div>


</div>
{%endblock%}

{%block js%}
<script language="javascript" type="text/javascript">
  function link_checkbox(dataset) {
      cell = $("<td>");
      check = $('<input type="checkbox" class="checkbox checkbox-selected" ' +
		'name="selected_datasets" checked="checked">');
      check.val(JSON.stringify(dataset));
      cell.append(check);
      return cell;
  }

  function table_cell(value) {
      cell = $("<td>");
      cell.html(value);
      return cell;
  }

  function render_table(table_id, data_attr_name) {
      $(table_id + " tbody tr").remove();
      table_data = JSON.parse($(table_id).attr(data_attr_name));
      if(table_data.length < 1) {
	  row = $("<tr>")
	  cell = $('<td colspan="100%" align="center">');
	  cell.append(
	      $('<span class="glyphicon glyphicon-info-sign text-info">'));
	  cell.append("&nbsp;");
	  cell.append("No genotype datasets remaining.");
	  row.append(cell);
	  $(table_id + " tbody").append(row);
      }
      table_data.forEach(function(dataset) {
	  row = $("<tr>")
	  row.append(link_checkbox(dataset));
	  row.append(table_cell(dataset.InbredSetName));
	  row.append(table_cell(dataset.dataset_name));
	  row.append(table_cell(dataset.dataset_fullname));
	  row.append(table_cell(dataset.dataset_shortname));
	  $(table_id + " tbody").append(row);
      });
  }

  function in_array(dataset, datasets) {
      found = datasets.filter(function(dst) {
	  return (dst.SpeciesId == dataset.SpeciesId &&
		  dst.InbredSetId == dataset.InbredSetId &&
		  dst.GenoFreezeId == dataset.GenoFreezeId);
      });
      return found.length > 0;
  }

  function remove_from_table_data(dataset, table_id, data_attr_name) {
      without_dataset = JSON.parse($(table_id).attr(data_attr_name)).filter(
	  function(dst) {
	      return !(dst.SpeciesId == dataset.SpeciesId &&
		       dst.InbredSetId == dataset.InbredSetId &&
		       dst.GenoFreezeId == dataset.GenoFreezeId);
	  });
      $(table_id).attr(data_attr_name, JSON.stringify(without_dataset));
  }

  function toggle_link_button() {
      num_groups = $("#frm-link-genotypes select option").length - 1;
      num_selected = JSON.parse(
	  $("#tbl-link-genotypes").attr("data-selected-datasets")).length;
      if(num_groups > 0 && num_selected > 0) {
	  $("#frm-link-genotypes input[type='submit']").prop("disabled", false);
      } else {
	  $("#frm-link-genotypes input[type='submit']").prop("disabled", true);
      }
  }

  $(document).ready(function() {
      $("#frm-search-traits").submit(function(event) {
	  event.preventDefault();
	  return false;
      });
      /* $("#txt-query").keyup(debounced_search()); */
      $(".checkbox-search").change(function(event) {
          if(this.checked) {
              selected = JSON.parse(
		  $("#tbl-link-genotypes").attr("data-selected-datasets"));
	      this_item = JSON.parse(this.value);
	      if(!in_array(this_item, selected)) {
		  selected.push(this_item);
	      }
	      $("#tbl-link-genotypes").attr(
		  "data-selected-datasets",
		  JSON.stringify(Array.from(selected)));
	      /* Remove from source table */
	      remove_from_table_data(
		  this_item, "#tbl-genotypes", "data-datasets");
	      /* Re-render tables */
	      render_table("#tbl-link-genotypes", "data-selected-datasets");
	      render_table("#tbl-genotypes", "data-datasets");
	      toggle_link_button();
          }
      });
  });
</script>
{%endblock%}
